<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f172a" />
    <meta name="robots" content="noindex, nofollow">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gallery">
    <link rel="manifest" href="manifest.json" />
    <title>Sharf-Aldin Gallery</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: auto; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Storage API using localStorage
        window.storage = {
            get: (key, shared) => {
                const storageKey = shared ? `shared_${key}` : `private_${key}`;
                const value = localStorage.getItem(storageKey);
                return Promise.resolve(value ? { value } : null);
            },
            set: (key, value, shared) => {
                const storageKey = shared ? `shared_${key}` : `private_${key}`;
                localStorage.setItem(storageKey, value);
                return Promise.resolve({ key: storageKey, value, shared });
            },
            delete: (key, shared) => {
                const storageKey = shared ? `shared_${key}` : `private_${key}`;
                localStorage.removeItem(storageKey);
                return Promise.resolve({ key: storageKey, deleted: true, shared });
            }
        };

        // Icons
        const Package = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16.5 9.4l-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>;
        const DollarSign = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>;
        const Users = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const TrendingUp = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
        const CreditCard = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>;
        const AlertCircle = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;
        const Plus = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const Search = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>;
        const Download = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const Edit = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
        const Trash2 = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const Save = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const ArrowUpDown = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></svg>;
        const Calendar = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        const Bell = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>;
        const X = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const History = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.72"/></svg>;
        const ChevronDown = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg>;
        const ChevronUp = (props) => <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="18 15 12 9 6 15"/></svg>;

        // Utilities
        const generateId = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(amount);
        const formatDate = (date) => new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

        // ─── MAIN APP ────────────────────────────────────────────────────────────────
        function InventoryManagementSystem() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [loading, setLoading]     = useState(true);
            const [products, setProducts]           = useState([]);
            const [sales, setSales]                 = useState([]);
            const [customers, setCustomers]         = useState([]);
            const [installments, setInstallments]   = useState([]);
            const [movements, setMovements]         = useState([]);
            const [priceHistory, setPriceHistory]   = useState([]);


            useEffect(() => {
                const loadData = async () => {
                    try {
                        const [pd, sd, cd, id, md, phd] = await Promise.all([
                            window.storage.get('products', true).catch(() => null),
                            window.storage.get('sales', true).catch(() => null),
                            window.storage.get('customers', true).catch(() => null),
                            window.storage.get('installments', true).catch(() => null),
                            window.storage.get('movements', true).catch(() => null),
                            window.storage.get('priceHistory', true).catch(() => null),
                        ]);
                        if (pd?.value)  setProducts(JSON.parse(pd.value));
                        if (sd?.value)  setSales(JSON.parse(sd.value));
                        if (cd?.value)  setCustomers(JSON.parse(cd.value));
                        if (id?.value)  setInstallments(JSON.parse(id.value));
                        if (md?.value)  setMovements(JSON.parse(md.value));
                        if (phd?.value) setPriceHistory(JSON.parse(phd.value));
                    } catch (e) { console.error(e); }
                    finally { setLoading(false); }
                };
                loadData();
            }, []);

            useEffect(() => { if (!loading) window.storage.set('products', JSON.stringify(products), true).catch(console.error); }, [products, loading]);
            useEffect(() => { if (!loading) window.storage.set('sales', JSON.stringify(sales), true).catch(console.error); }, [sales, loading]);
            useEffect(() => { if (!loading) window.storage.set('customers', JSON.stringify(customers), true).catch(console.error); }, [customers, loading]);
            useEffect(() => { if (!loading) window.storage.set('installments', JSON.stringify(installments), true).catch(console.error); }, [installments, loading]);
            useEffect(() => { if (!loading) window.storage.set('movements', JSON.stringify(movements), true).catch(console.error); }, [movements, loading]);
            useEffect(() => { if (!loading) window.storage.set('priceHistory', JSON.stringify(priceHistory), true).catch(console.error); }, [priceHistory, loading]);

            // FIX 3 – Export Data as JSON download
            const exportData = () => {
                const data = { products, sales, customers, installments, exportedAt: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url  = URL.createObjectURL(blob);
                const a    = document.createElement('a');
                a.href     = url;
                a.download = `gallery-export-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // FIX 4 – Delete sale + restore stock
            const deleteSale = (saleId) => {
                const sale = sales.find(s => s.id === saleId);
                if (!sale) return;
                if (!confirm('Delete this sale? Stock will be restored.')) return;
                setProducts(prev => prev.map(p =>
                    p.id === sale.productId
                        ? { ...p, quantityInStock: p.quantityInStock + sale.quantity,
                                  quantityInDisplay: p.quantityInDisplay + sale.quantity }
                        : p
                ));
                setSales(prev => prev.filter(s => s.id !== saleId));
            };



            if (loading) return <Spinner text="Loading system…" />;

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
                    {/* Header */}
                    <header className="bg-slate-900/50 backdrop-blur-lg border-b border-amber-500/20 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-gradient-to-br from-amber-400 to-amber-600 rounded-lg flex items-center justify-center">
                                    <Package className="w-6 h-6 text-slate-900" />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-white">Sharf-Aldin Gallery</h1>
                                    <p className="text-xs text-amber-400">Inventory & Sales Management</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                {/* FIX 3 – working export */}
                                <button onClick={exportData} className="px-4 py-2 bg-amber-500/10 text-amber-400 rounded-lg hover:bg-amber-500/20 transition-colors text-sm border border-amber-500/20 flex items-center gap-2">
                                    <Download className="w-4 h-4" /> Export Data
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Nav */}
                    <nav className="bg-slate-900/30 backdrop-blur border-b border-slate-700/50">
                        <div className="max-w-7xl mx-auto px-4">
                            <div className="flex gap-1 overflow-x-auto">
                                {[
                                    { id: 'dashboard',    label: 'Dashboard',    icon: TrendingUp },
                                    { id: 'products',     label: 'Products',     icon: Package },
                                    { id: 'sales',        label: 'Sales',        icon: DollarSign },
                                    { id: 'customers',    label: 'Customers',    icon: Users },
                                    { id: 'installments', label: 'Installments', icon: CreditCard },
                                    { id: 'reports',      label: 'Reports',      icon: TrendingUp },
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                                        className={`px-6 py-3 font-medium transition-all flex items-center gap-2 whitespace-nowrap ${activeTab === tab.id ? 'text-amber-400 border-b-2 border-amber-400 bg-amber-500/5' : 'text-slate-400 hover:text-white hover:bg-slate-800/50'}`}>
                                        <tab.icon className="w-4 h-4" />{tab.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 py-6">
                        {activeTab === 'dashboard'    && <Dashboard products={products} sales={sales} installments={installments} customers={customers} />}
                        {activeTab === 'products'     && <ProductsTab products={products} setProducts={setProducts} setPriceHistory={setPriceHistory} movements={movements} setMovements={setMovements} />}
                        {activeTab === 'sales'        && <SalesTab sales={sales} setSales={setSales} products={products} setProducts={setProducts} customers={customers} deleteSale={deleteSale} />}
                        {activeTab === 'customers'    && <CustomersTab customers={customers} setCustomers={setCustomers} installments={installments} sales={sales} products={products} />}
                        {activeTab === 'installments' && <InstallmentsTab installments={installments} setInstallments={setInstallments} customers={customers} sales={sales} />}
                        {activeTab === 'reports'      && <ReportsTab sales={sales} products={products} installments={installments} />}
                    </main>
                </div>
            );
        }

        function Spinner({ text }) {
            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center">
                    <div className="text-white text-xl">{text}</div>
                </div>
            );
        }

        // ─── AUTH ────────────────────────────────────────────────────────────────────
        // ─── DASHBOARD ───────────────────────────────────────────────────────────────
        function Dashboard({ products, sales, installments, customers }) {
            const now  = new Date();
            const monthlySales = sales.filter(s => { const d = new Date(s.date); return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear(); });
            const totalRevenue = monthlySales.reduce((s, x) => s + x.total, 0);
            const totalProfit  = monthlySales.reduce((s, x) => s + x.profit, 0);
            const inventoryValue = products.reduce((s, p) => s + p.purchaseCost * p.quantityInStock, 0);
            const outstanding  = installments.filter(i => i.status !== 'Paid');
            const totalOutstanding = outstanding.reduce((s, i) => s + i.remainingBalance, 0);
            const lowStock     = products.filter(p => p.quantityInStock <= p.minimumStockAlert && p.status === 'Active');
            const topProducts  = [...products].map(p => ({ ...p, soldQty: sales.filter(s => s.productId === p.id).reduce((a, s) => a + s.quantity, 0) })).sort((a,b) => b.soldQty - a.soldQty).slice(0,5);

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard title="Monthly Revenue"      value={formatCurrency(totalRevenue)}    icon={DollarSign}  color="emerald" subtitle={`${monthlySales.length} sales this month`} />
                        <StatCard title="Monthly Profit"       value={formatCurrency(totalProfit)}     icon={TrendingUp}  color="blue"    subtitle={`${((totalProfit/totalRevenue)*100||0).toFixed(1)}% margin`} />
                        <StatCard title="Inventory Value"      value={formatCurrency(inventoryValue)}  icon={Package}     color="purple"  subtitle={`${products.length} products`} />
                        <StatCard title="Outstanding Payments" value={formatCurrency(totalOutstanding)} icon={CreditCard} color="amber"   subtitle={`${outstanding.length} pending`} />
                    </div>
                    {lowStock.length > 0 && (
                        <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
                            <div className="flex items-start gap-3">
                                <AlertCircle className="w-5 h-5 text-red-400 mt-0.5" />
                                <div>
                                    <h3 className="text-red-400 font-semibold mb-2">Low Stock Alert</h3>
                                    {lowStock.map(p => <div key={p.id} className="text-sm text-red-300">{p.name}: {p.quantityInStock} units (min: {p.minimumStockAlert})</div>)}
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700/50">
                            <h2 className="text-lg font-semibold text-white mb-4 flex items-center gap-2"><TrendingUp className="w-5 h-5 text-amber-400" /> Top Selling Products</h2>
                            <div className="space-y-3">
                                {topProducts.length > 0 ? topProducts.map((p, i) => (
                                    <div key={p.id} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg">
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 bg-amber-500/20 rounded-lg flex items-center justify-center text-amber-400 font-bold text-sm">{i+1}</div>
                                            <div><div className="text-white font-medium">{p.name}</div><div className="text-xs text-slate-400">{p.category}</div></div>
                                        </div>
                                        <div className="text-right"><div className="text-white font-semibold">{p.soldQty} sold</div><div className="text-xs text-slate-400">Stock: {p.quantityInStock}</div></div>
                                    </div>
                                )) : <div className="text-center text-slate-400 py-8">No sales data yet</div>}
                            </div>
                        </div>
                        <div className="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700/50">
                            <h2 className="text-lg font-semibold text-white mb-4 flex items-center gap-2"><Bell className="w-5 h-5 text-amber-400" /> Recent Sales</h2>
                            <div className="space-y-3">
                                {sales.slice(-5).reverse().map(sale => {
                                    const product = products.find(p => p.id === sale.productId);
                                    return (
                                        <div key={sale.id} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg">
                                            <div><div className="text-white font-medium">{product?.name || 'Unknown'}</div><div className="text-xs text-slate-400">{formatDate(sale.date)}</div></div>
                                            <div className="text-right"><div className="text-emerald-400 font-semibold">{formatCurrency(sale.total)}</div><div className="text-xs text-slate-400">Qty: {sale.quantity}</div></div>
                                        </div>
                                    );
                                })}
                                {sales.length === 0 && <div className="text-center text-slate-400 py-8">No sales yet</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function StatCard({ title, value, icon: Icon, color, subtitle }) {
            const c = { emerald: 'from-emerald-500/20 to-emerald-600/20 border-emerald-500/30 text-emerald-400', blue: 'from-blue-500/20 to-blue-600/20 border-blue-500/30 text-blue-400', purple: 'from-purple-500/20 to-purple-600/20 border-purple-500/30 text-purple-400', amber: 'from-amber-500/20 to-amber-600/20 border-amber-500/30 text-amber-400' };
            return (
                <div className={`bg-gradient-to-br ${c[color]} backdrop-blur rounded-xl p-6 border`}>
                    <div className="flex items-start justify-between mb-3"><div className="text-sm text-slate-300 font-medium">{title}</div><Icon className="w-5 h-5" /></div>
                    <div className="text-2xl font-bold text-white mb-1">{value}</div>
                    <div className="text-xs text-slate-400">{subtitle}</div>
                </div>
            );
        }

        // ─── PRODUCTS TAB ────────────────────────────────────────────────────────────
        function ProductsTab({ products, setProducts, setPriceHistory, movements, setMovements }) {
            const [showAddForm, setShowAddForm]         = useState(false);
            const [editingProduct, setEditingProduct]   = useState(null);
            const [searchTerm, setSearchTerm]           = useState('');
            const [filterCategory, setFilterCategory]   = useState('all');
            const [showMovementModal, setShowMovementModal] = useState(null);

            const categories = [...new Set(products.map(p => p.category))];
            const filtered = products.filter(p => {
                const matchSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase()) || p.barcode?.includes(searchTerm);
                const matchCat    = filterCategory === 'all' || p.category === filterCategory;
                return matchSearch && matchCat;
            });

            const addProduct = (data) => {
                setProducts([...products, { id: generateId(), ...data, quantityInStock: data.quantityInDisplay + data.quantityInStorage, createdAt: new Date().toISOString() }]);
                setShowAddForm(false);
            };

            const updateProduct = (id, updates) => {
                const old = products.find(p => p.id === id);
                if (old.currentSellingPrice !== updates.currentSellingPrice) {
                    setPriceHistory(prev => [...prev, { id: generateId(), productId: id, oldPrice: old.currentSellingPrice, newPrice: updates.currentSellingPrice, date: new Date().toISOString(), reason: updates.priceChangeReason || 'Manual update' }]);
                }
                setProducts(products.map(p => p.id === id ? { ...p, ...updates, quantityInStock: (updates.quantityInDisplay ?? p.quantityInDisplay) + (updates.quantityInStorage ?? p.quantityInStorage) } : p));
                setEditingProduct(null);
            };

            const deleteProduct = (id) => { if (confirm('Delete this product?')) setProducts(products.filter(p => p.id !== id)); };

            const moveStock = (productId, from, to, qty) => {
                const p = products.find(x => x.id === productId);
                if (!p) return;
                setMovements([...movements, { id: generateId(), productId, from, to, quantity: qty, date: new Date().toISOString() }]);
                const upd = { quantityInDisplay: p.quantityInDisplay, quantityInStorage: p.quantityInStorage };
                if (from === 'display')  upd.quantityInDisplay  -= qty;
                if (from === 'storage') upd.quantityInStorage -= qty;
                if (to   === 'display')  upd.quantityInDisplay  += qty;
                if (to   === 'storage') upd.quantityInStorage += qty;
                updateProduct(productId, upd);
                setShowMovementModal(null);
            };

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
                        <div><h2 className="text-2xl font-bold text-white">Product Inventory</h2><p className="text-slate-400 text-sm">Manage your product catalog and stock levels</p></div>
                        <button onClick={() => setShowAddForm(true)} className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg transition-colors flex items-center gap-2"><Plus className="w-4 h-4" /> Add Product</button>
                    </div>
                    <div className="flex flex-col sm:flex-row gap-4">
                        <div className="flex-1 relative">
                            <Search className="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                            <input type="text" placeholder="Search products or scan barcode…" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-amber-500/50" />
                        </div>
                        <select value={filterCategory} onChange={e => setFilterCategory(e.target.value)} className="px-4 py-2 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50">
                            <option value="all">All Categories</option>
                            {categories.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>
                    <div className="bg-slate-800/50 backdrop-blur rounded-xl border border-slate-700/50 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        {['Product','Category','Price','Cost','Stock','Display','Storage','Status','Actions'].map(h => (
                                            <th key={h} className="px-4 py-3 text-left text-xs font-semibold text-slate-300 uppercase">{h}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700/50">
                                    {filtered.map(product => (
                                        <tr key={product.id} className="hover:bg-slate-900/30 transition-colors">
                                            <td className="px-4 py-3"><div className="font-medium text-white">{product.name}</div>{product.barcode && <div className="text-xs text-slate-400">Barcode: {product.barcode}</div>}</td>
                                            <td className="px-4 py-3 text-slate-300">{product.category}</td>
                                            <td className="px-4 py-3 text-emerald-400 font-semibold">{formatCurrency(product.currentSellingPrice)}</td>
                                            <td className="px-4 py-3 text-slate-300">{formatCurrency(product.purchaseCost)}</td>
                                            <td className="px-4 py-3"><span className={`font-semibold ${product.quantityInStock <= product.minimumStockAlert ? 'text-red-400' : 'text-white'}`}>{product.quantityInStock}</span></td>
                                            <td className="px-4 py-3 text-slate-300">{product.quantityInDisplay}</td>
                                            <td className="px-4 py-3 text-slate-300">{product.quantityInStorage}</td>
                                            <td className="px-4 py-3"><span className={`px-2 py-1 rounded-full text-xs font-medium ${product.status === 'Active' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-600/20 text-slate-400'}`}>{product.status}</span></td>
                                            <td className="px-4 py-3">
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => setShowMovementModal(product)} className="p-1.5 hover:bg-blue-500/20 text-blue-400 rounded" title="Move stock"><ArrowUpDown className="w-4 h-4" /></button>
                                                    <button onClick={() => setEditingProduct(product)} className="p-1.5 hover:bg-amber-500/20 text-amber-400 rounded" title="Edit"><Edit className="w-4 h-4" /></button>
                                                    <button onClick={() => deleteProduct(product.id)} className="p-1.5 hover:bg-red-500/20 text-red-400 rounded" title="Delete"><Trash2 className="w-4 h-4" /></button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {filtered.length === 0 && <div className="text-center py-12 text-slate-400">No products found</div>}
                        </div>
                    </div>
                    {(showAddForm || editingProduct) && <ProductForm product={editingProduct} onSave={editingProduct ? updateProduct : addProduct} onCancel={() => { setShowAddForm(false); setEditingProduct(null); }} />}
                    {showMovementModal && <StockMovementModal product={showMovementModal} onMove={moveStock} onClose={() => setShowMovementModal(null)} />}
                </div>
            );
        }

        function ProductForm({ product, onSave, onCancel }) {
            const [formData, setFormData] = useState(product || { name: '', barcode: '', category: '', supplier: '', purchaseCost: '', currentSellingPrice: '', quantityInDisplay: '', quantityInStorage: '', minimumStockAlert: 5, status: 'Active' });
            const handleSubmit = (e) => { e.preventDefault(); product ? onSave(product.id, formData) : onSave(formData); };
            const field = (label, key, type = 'text', extra = {}) => (
                <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">{label}</label>
                    <input type={type} value={formData[key]} onChange={e => setFormData({...formData, [key]: type === 'number' ? (parseFloat(e.target.value) || 0) : e.target.value})} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50" {...extra} />
                </div>
            );
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 rounded-xl border border-slate-700/50 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6 border-b border-slate-700/50"><h3 className="text-xl font-bold text-white">{product ? 'Edit Product' : 'Add New Product'}</h3></div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {field('Product Name *', 'name', 'text', { required: true })}
                                {field('Barcode', 'barcode')}
                                {field('Category *', 'category', 'text', { required: true, placeholder: 'e.g., Chandeliers, Lighting' })}
                                {field('Supplier', 'supplier')}
                                {field('Purchase Cost *', 'purchaseCost', 'number', { required: true, step: '0.01' })}
                                {field('Selling Price *', 'currentSellingPrice', 'number', { required: true, step: '0.01' })}
                                {field('Qty in Display', 'quantityInDisplay', 'number', { placeholder: 'Enter qty' })}
                                {field('Qty in Storage', 'quantityInStorage', 'number', { placeholder: 'Enter qty' })}
                                {field('Min Stock Alert', 'minimumStockAlert', 'number')}
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Status</label>
                                    <select value={formData.status} onChange={e => setFormData({...formData, status: e.target.value})} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50">
                                        <option value="Active">Active</option>
                                        <option value="Discontinued">Discontinued</option>
                                    </select>
                                </div>
                            </div>
                            <div className="flex gap-3 pt-4 border-t border-slate-700/50">
                                <button type="submit" className="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg"><Save className="w-4 h-4 inline mr-2" />Save Product</button>
                                <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function StockMovementModal({ product, onMove, onClose }) {
            const [from, setFrom]     = useState('storage');
            const [to, setTo]         = useState('display');
            const [quantity, setQty]  = useState(1);
            const max = from === 'display' ? product.quantityInDisplay : product.quantityInStorage;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 rounded-xl border border-slate-700/50 max-w-md w-full">
                        <div className="p-6 border-b border-slate-700/50"><h3 className="text-xl font-bold text-white">Move Stock</h3><p className="text-sm text-slate-400 mt-1">{product.name}</p></div>
                        <form onSubmit={e => { e.preventDefault(); onMove(product.id, from, to, quantity); }} className="p-6 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">From</label>
                                <select value={from} onChange={e => setFrom(e.target.value)} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50">
                                    <option value="display">Display ({product.quantityInDisplay} available)</option>
                                    <option value="storage">Storage ({product.quantityInStorage} available)</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">To</label>
                                <select value={to} onChange={e => setTo(e.target.value)} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50">
                                    <option value="display">Display</option>
                                    <option value="storage">Storage</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Quantity (max: {max})</label>
                                <input type="number" min="1" max={max} value={quantity} onChange={e => setQty(parseInt(e.target.value) || 1)} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50" />
                            </div>
                            <div className="flex gap-3 pt-4 border-t border-slate-700/50">
                                <button type="submit" disabled={from === to || quantity > max || quantity < 1} className="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 disabled:bg-slate-600 disabled:cursor-not-allowed text-slate-900 font-semibold rounded-lg">Move Stock</button>
                                <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // ─── SALES TAB ───────────────────────────────────────────────────────────────
        function SalesTab({ sales, setSales, products, setProducts, customers, deleteSale }) {
            const [showSaleForm, setShowSaleForm] = useState(false);
            const [searchTerm, setSearchTerm]     = useState('');

            const filtered = sales.filter(sale => {
                const p = products.find(x => x.id === sale.productId);
                return p?.name.toLowerCase().includes(searchTerm.toLowerCase()) || sale.invoiceNumber.includes(searchTerm);
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            const createSale = (data) => {
                const product = products.find(p => p.id === data.productId);
                if (!product || product.quantityInStock < data.quantity) { alert('Insufficient stock!'); return; }
                const total  = data.sellingPrice * data.quantity - (data.discount || 0);
                const profit = (data.sellingPrice - product.purchaseCost) * data.quantity - (data.discount || 0);
                setSales([...sales, { id: generateId(), invoiceNumber: `INV-${Date.now()}`, date: new Date().toISOString(), ...data, total, profit, purchaseCost: product.purchaseCost }]);
                setProducts(products.map(p => p.id === data.productId ? { ...p, quantityInDisplay: Math.max(0, p.quantityInDisplay - data.quantity), quantityInStock: p.quantityInStock - data.quantity } : p));
                setShowSaleForm(false);
            };

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
                        <div><h2 className="text-2xl font-bold text-white">Sales Management</h2><p className="text-slate-400 text-sm">Track and manage all sales transactions</p></div>
                        <button onClick={() => setShowSaleForm(true)} className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg flex items-center gap-2"><Plus className="w-4 h-4" /> New Sale</button>
                    </div>
                    <div className="relative">
                        <Search className="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                        <input type="text" placeholder="Search by product or invoice number…" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-amber-500/50" />
                    </div>
                    <div className="bg-slate-800/50 backdrop-blur rounded-xl border border-slate-700/50 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        {['Invoice','Date','Customer','Product','Qty','Price','Discount','Total','Profit','Actions'].map(h => (
                                            <th key={h} className="px-4 py-3 text-left text-xs font-semibold text-slate-300 uppercase">{h}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700/50">
                                    {filtered.map(sale => {
                                        const product  = products.find(p => p.id === sale.productId);
                                        const customer = customers.find(c => c.id === sale.customerId);
                                        return (
                                            <tr key={sale.id} className="hover:bg-slate-900/30 transition-colors">
                                                <td className="px-4 py-3 font-medium text-white">{sale.invoiceNumber}</td>
                                                <td className="px-4 py-3 text-slate-300">{formatDate(sale.date)}</td>
                                                <td className="px-4 py-3 text-slate-300">{customer?.fullName || <span className="text-slate-500 italic">Walk-in</span>}</td>
                                                <td className="px-4 py-3 text-white">{product?.name || 'Unknown'}</td>
                                                <td className="px-4 py-3 text-slate-300">{sale.quantity}</td>
                                                <td className="px-4 py-3 text-slate-300">{formatCurrency(sale.sellingPrice)}</td>
                                                <td className="px-4 py-3 text-orange-400">{formatCurrency(sale.discount || 0)}</td>
                                                <td className="px-4 py-3 text-emerald-400 font-semibold">{formatCurrency(sale.total)}</td>
                                                <td className="px-4 py-3"><span className={`font-semibold ${sale.profit > 0 ? 'text-emerald-400' : 'text-red-400'}`}>{formatCurrency(sale.profit)}</span></td>
                                                {/* FIX 4 – delete sale button */}
                                                <td className="px-4 py-3">
                                                    <button onClick={() => deleteSale(sale.id)} className="p-1.5 hover:bg-red-500/20 text-red-400 rounded transition-colors" title="Delete sale"><Trash2 className="w-4 h-4" /></button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                            {filtered.length === 0 && <div className="text-center py-12 text-slate-400">No sales found</div>}
                        </div>
                    </div>
                    {showSaleForm && <SaleForm products={products.filter(p => p.status === 'Active' && p.quantityInStock > 0)} customers={customers} onSave={createSale} onCancel={() => setShowSaleForm(false)} />}
                </div>
            );
        }

        // FIX 2 – quantity input uses empty string as initial so the field is truly blank
        function SaleForm({ products, customers, onSave, onCancel }) {
            const [productId, setProductId]     = useState('');
            const [quantityRaw, setQuantityRaw] = useState('');   // FIX 2
            const [sellingPrice, setSellingPrice] = useState('');
            const [discount, setDiscount]         = useState('');
            const [customerId, setCustomerId]     = useState('');

            const selectedProduct = products.find(p => p.id === productId);
            const quantity        = parseInt(quantityRaw) || 0;
            const price           = parseFloat(sellingPrice) || 0;
            const disc            = parseFloat(discount) || 0;
            const total           = price * quantity - disc;
            const profit          = selectedProduct ? (price - selectedProduct.purchaseCost) * quantity - disc : 0;

            // Auto-fill price when product changes
            useEffect(() => {
                if (selectedProduct) setSellingPrice(String(selectedProduct.currentSellingPrice));
            }, [productId]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!selectedProduct) return;
                onSave({ productId, quantity, sellingPrice: price, discount: disc, customerId });
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 rounded-xl border border-slate-700/50 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6 border-b border-slate-700/50"><h3 className="text-xl font-bold text-white">New Sale</h3></div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Product *</label>
                                <select required value={productId} onChange={e => { setProductId(e.target.value); setQuantityRaw(''); }} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50">
                                    <option value="">Select a product</option>
                                    {products.map(p => <option key={p.id} value={p.id}>{p.name} — Stock: {p.quantityInStock} — {formatCurrency(p.currentSellingPrice)}</option>)}
                                </select>
                            </div>
                            {selectedProduct && (
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-2">Quantity * (max: {selectedProduct.quantityInStock})</label>
                                        {/* FIX 2 – value is the raw string, placeholder guides user */}
                                        <input type="number" required min="1" max={selectedProduct.quantityInStock}
                                            value={quantityRaw}
                                            placeholder="Enter qty"
                                            onChange={e => setQuantityRaw(e.target.value)}
                                            className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-amber-500/50" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-2">Selling Price *</label>
                                        <input type="number" required step="0.01" value={sellingPrice} onChange={e => setSellingPrice(e.target.value)} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-2">Discount</label>
                                        <input type="number" step="0.01" placeholder="0" value={discount} onChange={e => setDiscount(e.target.value)} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-amber-500/50" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-2">Customer (Optional)</label>
                                        <select value={customerId} onChange={e => setCustomerId(e.target.value)} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50">
                                            <option value="">Walk-in Customer</option>
                                            {customers.map(c => <option key={c.id} value={c.id}>{c.fullName}</option>)}
                                        </select>
                                    </div>
                                </div>
                            )}
                            {selectedProduct && quantity > 0 && (
                                <div className="bg-slate-900/50 rounded-lg p-4 space-y-2">
                                    <div className="flex justify-between text-sm"><span className="text-slate-400">Subtotal:</span><span className="text-white font-medium">{formatCurrency(price * quantity)}</span></div>
                                    <div className="flex justify-between text-sm"><span className="text-slate-400">Discount:</span><span className="text-orange-400 font-medium">-{formatCurrency(disc)}</span></div>
                                    <div className="flex justify-between text-lg border-t border-slate-700/50 pt-2"><span className="text-white font-semibold">Total:</span><span className="text-emerald-400 font-bold">{formatCurrency(total)}</span></div>
                                    <div className="flex justify-between text-sm"><span className="text-slate-400">Expected Profit:</span><span className={`font-semibold ${profit > 0 ? 'text-emerald-400' : 'text-red-400'}`}>{formatCurrency(profit)}</span></div>
                                </div>
                            )}
                            <div className="flex gap-3 pt-4 border-t border-slate-700/50">
                                <button type="submit" disabled={!selectedProduct || quantity < 1} className="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 disabled:bg-slate-600 disabled:cursor-not-allowed text-slate-900 font-semibold rounded-lg">Complete Sale</button>
                                <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // ─── CUSTOMERS TAB (FIX 1 – purchase history) ────────────────────────────────
        function CustomersTab({ customers, setCustomers, installments, sales, products }) {
            const [showAddForm, setShowAddForm]         = useState(false);
            const [editingCustomer, setEditingCustomer] = useState(null);
            const [searchTerm, setSearchTerm]           = useState('');
            const [historyCustomer, setHistoryCustomer] = useState(null);

            const filtered = customers.filter(c =>
                c.fullName.toLowerCase().includes(searchTerm.toLowerCase()) || c.phone.includes(searchTerm)
            );

            const addCustomer = (data) => { setCustomers([...customers, { id: generateId(), ...data, createdAt: new Date().toISOString() }]); setShowAddForm(false); };
            const updateCustomer = (id, updates) => { setCustomers(customers.map(c => c.id === id ? {...c, ...updates} : c)); setEditingCustomer(null); };
            const deleteCustomer = (id) => {
                if (installments.some(i => i.customerId === id && i.status !== 'Paid')) { alert('Cannot delete customer with active installments'); return; }
                if (confirm('Delete this customer?')) setCustomers(customers.filter(c => c.id !== id));
            };

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
                        <div><h2 className="text-2xl font-bold text-white">Customer Management</h2><p className="text-slate-400 text-sm">Manage customer information and relationships</p></div>
                        <button onClick={() => setShowAddForm(true)} className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg flex items-center gap-2"><Plus className="w-4 h-4" /> Add Customer</button>
                    </div>
                    <div className="relative">
                        <Search className="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                        <input type="text" placeholder="Search by name or phone…" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-amber-500/50" />
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {filtered.map(customer => {
                            const ci   = installments.filter(i => i.customerId === customer.id);
                            const ai   = ci.filter(i => i.status !== 'Paid');
                            const owed = ai.reduce((s, i) => s + i.remainingBalance, 0);
                            const cs   = sales.filter(s => s.customerId === customer.id);
                            const spent = cs.reduce((a, s) => a + s.total, 0);
                            return (
                                <div key={customer.id} className="bg-slate-800/50 backdrop-blur rounded-xl p-5 border border-slate-700/50 hover:border-amber-500/30 transition-colors">
                                    <div className="flex items-start justify-between mb-3">
                                        <div className="w-12 h-12 bg-gradient-to-br from-amber-400 to-amber-600 rounded-full flex items-center justify-center text-slate-900 font-bold text-lg">{customer.fullName.charAt(0).toUpperCase()}</div>
                                        <div className="flex gap-1">
                                            {/* FIX 1 – history button */}
                                            <button onClick={() => setHistoryCustomer(customer)} className="p-1.5 hover:bg-blue-500/20 text-blue-400 rounded transition-colors" title="Purchase History"><History className="w-4 h-4" /></button>
                                            <button onClick={() => setEditingCustomer(customer)} className="p-1.5 hover:bg-amber-500/20 text-amber-400 rounded transition-colors"><Edit className="w-4 h-4" /></button>
                                            <button onClick={() => deleteCustomer(customer.id)} className="p-1.5 hover:bg-red-500/20 text-red-400 rounded transition-colors"><Trash2 className="w-4 h-4" /></button>
                                        </div>
                                    </div>
                                    <h3 className="text-white font-semibold text-lg mb-1">{customer.fullName}</h3>
                                    <div className="space-y-1 text-sm text-slate-400 mb-4">
                                        <div>{customer.phone}</div>
                                        {customer.address && <div>{customer.address}</div>}
                                    </div>
                                    <div className="pt-3 border-t border-slate-700/50 space-y-2">
                                        <div className="flex justify-between text-sm"><span className="text-slate-400">Purchases:</span><span className="text-white font-medium">{cs.length}</span></div>
                                        <div className="flex justify-between text-sm"><span className="text-slate-400">Total Spent:</span><span className="text-emerald-400 font-semibold">{formatCurrency(spent)}</span></div>
                                        {ai.length > 0 && <div className="flex justify-between text-sm"><span className="text-slate-400">Amount Owed:</span><span className="text-amber-400 font-semibold">{formatCurrency(owed)}</span></div>}
                                    </div>
                                    {customer.notes && <div className="mt-3 pt-3 border-t border-slate-700/50"><p className="text-xs text-slate-400 italic">{customer.notes}</p></div>}
                                </div>
                            );
                        })}
                    </div>
                    {filtered.length === 0 && <div className="text-center py-12 text-slate-400">No customers found</div>}
                    {(showAddForm || editingCustomer) && <CustomerForm customer={editingCustomer} onSave={editingCustomer ? updateCustomer : addCustomer} onCancel={() => { setShowAddForm(false); setEditingCustomer(null); }} />}
                    {/* FIX 1 – Purchase history modal */}
                    {historyCustomer && <PurchaseHistoryModal customer={historyCustomer} sales={sales.filter(s => s.customerId === historyCustomer.id)} products={products} onClose={() => setHistoryCustomer(null)} />}
                </div>
            );
        }

        // FIX 1 – Purchase History Modal
        function PurchaseHistoryModal({ customer, sales, products, onClose }) {
            const sorted = [...sales].sort((a,b) => new Date(b.date) - new Date(a.date));
            const total  = sorted.reduce((s, x) => s + x.total, 0);
            return (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 rounded-xl border border-slate-700/50 max-w-2xl w-full max-h-[85vh] flex flex-col">
                        <div className="p-6 border-b border-slate-700/50 flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white flex items-center gap-2"><History className="w-5 h-5 text-amber-400" /> Purchase History</h3>
                                <p className="text-sm text-slate-400 mt-1">{customer.fullName} · {sorted.length} transactions · Total: <span className="text-emerald-400 font-semibold">{formatCurrency(total)}</span></p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400"><X className="w-5 h-5" /></button>
                        </div>
                        <div className="overflow-y-auto flex-1">
                            {sorted.length === 0 ? (
                                <div className="text-center py-16 text-slate-400">No purchases yet</div>
                            ) : (
                                <table className="w-full">
                                    <thead className="bg-slate-900/60 sticky top-0">
                                        <tr>
                                            {['Invoice','Date','Product','Qty','Price','Discount','Total','Profit'].map(h => (
                                                <th key={h} className="px-4 py-3 text-left text-xs font-semibold text-slate-300 uppercase">{h}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-700/50">
                                        {sorted.map(sale => {
                                            const product = products.find(p => p.id === sale.productId);
                                            return (
                                                <tr key={sale.id} className="hover:bg-slate-900/40 transition-colors">
                                                    <td className="px-4 py-3 text-white font-medium text-sm">{sale.invoiceNumber}</td>
                                                    <td className="px-4 py-3 text-slate-300 text-sm">{formatDate(sale.date)}</td>
                                                    <td className="px-4 py-3 text-white text-sm">{product?.name || 'Unknown'}</td>
                                                    <td className="px-4 py-3 text-slate-300 text-sm">{sale.quantity}</td>
                                                    <td className="px-4 py-3 text-slate-300 text-sm">{formatCurrency(sale.sellingPrice)}</td>
                                                    <td className="px-4 py-3 text-orange-400 text-sm">{formatCurrency(sale.discount || 0)}</td>
                                                    <td className="px-4 py-3 text-emerald-400 font-semibold text-sm">{formatCurrency(sale.total)}</td>
                                                    <td className="px-4 py-3 text-sm"><span className={`font-semibold ${sale.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{formatCurrency(sale.profit)}</span></td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            )}
                        </div>
                        <div className="p-4 border-t border-slate-700/50 bg-slate-900/30 flex justify-between items-center">
                            <span className="text-slate-400 text-sm font-medium">Total Spent</span>
                            <span className="text-emerald-400 font-bold text-lg">{formatCurrency(total)}</span>
                        </div>
                    </div>
                </div>
            );
        }

        function CustomerForm({ customer, onSave, onCancel }) {
            const [formData, setFormData] = useState(customer || { fullName: '', phone: '', address: '', notes: '' });
            const handleSubmit = (e) => { e.preventDefault(); customer ? onSave(customer.id, formData) : onSave(formData); };
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 rounded-xl border border-slate-700/50 max-w-md w-full">
                        <div className="p-6 border-b border-slate-700/50"><h3 className="text-xl font-bold text-white">{customer ? 'Edit Customer' : 'Add New Customer'}</h3></div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div><label className="block text-sm font-medium text-slate-300 mb-2">Full Name *</label><input type="text" required value={formData.fullName} onChange={e => setFormData({...formData, fullName: e.target.value})} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50" /></div>
                            <div><label className="block text-sm font-medium text-slate-300 mb-2">Phone *</label><input type="tel" required value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50" /></div>
                            <div><label className="block text-sm font-medium text-slate-300 mb-2">Address</label><input type="text" value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50" /></div>
                            <div><label className="block text-sm font-medium text-slate-300 mb-2">Notes</label><textarea value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})} rows="3" className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50" /></div>
                            <div className="flex gap-3 pt-4 border-t border-slate-700/50">
                                <button type="submit" className="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg">Save Customer</button>
                                <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // ─── INSTALLMENTS TAB ────────────────────────────────────────────────────────
        function InstallmentsTab({ installments, setInstallments, customers, sales }) {
            const [showAddForm, setShowAddForm]         = useState(false);
            const [showPaymentModal, setShowPaymentModal] = useState(null);
            const [filterStatus, setFilterStatus]       = useState('all');

            const filtered = installments.filter(i => filterStatus === 'all' || i.status === filterStatus).sort((a,b) => new Date(a.nextDueDate) - new Date(b.nextDueDate));

            const addInstallment = (data) => { setInstallments([...installments, { id: generateId(), ...data, createdAt: new Date().toISOString() }]); setShowAddForm(false); };

            const recordPayment = (installmentId, amount) => {
                setInstallments(installments.map(i => {
                    if (i.id !== installmentId) return i;
                    const newBalance = i.remainingBalance - amount;
                    const newStatus  = newBalance <= 0 ? 'Paid' : i.status;
                    let nextDueDate  = i.nextDueDate;
                    if (newBalance > 0) {
                        const d = new Date(i.nextDueDate);
                        if (i.frequency === 'Weekly')    d.setDate(d.getDate() + 7);
                        else if (i.frequency === 'Bi-weekly') d.setDate(d.getDate() + 14);
                        else if (i.frequency === 'Monthly')   d.setMonth(d.getMonth() + 1);
                        nextDueDate = d.toISOString();
                    }
                    return { ...i, remainingBalance: Math.max(0, newBalance), status: newStatus, nextDueDate };
                }));
                setShowPaymentModal(null);
            };

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
                        <div><h2 className="text-2xl font-bold text-white">Installment Plans</h2><p className="text-slate-400 text-sm">Track and manage payment plans</p></div>
                        <button onClick={() => setShowAddForm(true)} className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg flex items-center gap-2"><Plus className="w-4 h-4" /> New Plan</button>
                    </div>
                    <div className="flex gap-2">
                        {['all','Paid','Partial','Late'].map(s => (
                            <button key={s} onClick={() => setFilterStatus(s)} className={`px-4 py-2 rounded-lg font-medium transition-colors ${filterStatus === s ? 'bg-amber-500 text-slate-900' : 'bg-slate-800/50 text-slate-400 hover:bg-slate-700'}`}>{s === 'all' ? 'All' : s}</button>
                        ))}
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        {filtered.map(inst => {
                            const customer = customers.find(c => c.id === inst.customerId);
                            const isOverdue = new Date(inst.nextDueDate) < new Date() && inst.status !== 'Paid';
                            return (
                                <div key={inst.id} className={`bg-slate-800/50 backdrop-blur rounded-xl p-5 border ${isOverdue ? 'border-red-500/50' : 'border-slate-700/50'}`}>
                                    <div className="flex items-start justify-between mb-4">
                                        <div><h3 className="text-white font-semibold text-lg">{customer?.fullName || 'Unknown'}</h3><p className="text-sm text-slate-400">Invoice: {inst.invoiceNumber}</p></div>
                                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${inst.status === 'Paid' ? 'bg-emerald-500/20 text-emerald-400' : inst.status === 'Late' ? 'bg-red-500/20 text-red-400' : 'bg-amber-500/20 text-amber-400'}`}>{inst.status}</span>
                                    </div>
                                    <div className="space-y-3 mb-4">
                                        <div className="flex justify-between text-sm"><span className="text-slate-400">Total:</span><span className="text-white font-medium">{formatCurrency(inst.totalAmount)}</span></div>
                                        <div className="flex justify-between text-sm"><span className="text-slate-400">Down Payment:</span><span className="text-emerald-400">{formatCurrency(inst.downPayment)}</span></div>
                                        <div className="flex justify-between text-sm"><span className="text-slate-400">Remaining:</span><span className="text-amber-400 font-semibold">{formatCurrency(inst.remainingBalance)}</span></div>
                                        <div className="flex justify-between text-sm"><span className="text-slate-400">Installment:</span><span className="text-white">{formatCurrency(inst.installmentAmount)} / {inst.frequency}</span></div>
                                        {inst.status !== 'Paid' && <div className="flex justify-between text-sm"><span className="text-slate-400">Next Due:</span><span className={`font-medium ${isOverdue ? 'text-red-400' : 'text-white'}`}>{formatDate(inst.nextDueDate)}{isOverdue && ' (Overdue)'}</span></div>}
                                    </div>
                                    {inst.status !== 'Paid' && <button onClick={() => setShowPaymentModal(inst)} className="w-full px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg">Record Payment</button>}
                                </div>
                            );
                        })}
                    </div>
                    {filtered.length === 0 && <div className="text-center py-12 text-slate-400">No installments found</div>}
                    {showAddForm && <InstallmentForm customers={customers} sales={sales} onSave={addInstallment} onCancel={() => setShowAddForm(false)} />}
                    {showPaymentModal && <PaymentModal installment={showPaymentModal} onRecord={recordPayment} onClose={() => setShowPaymentModal(null)} />}
                </div>
            );
        }

        function InstallmentForm({ customers, sales, onSave, onCancel }) {
            const [formData, setFormData] = useState({ invoiceNumber: '', customerId: '', totalAmount: '', downPayment: '', installmentAmount: '', frequency: 'Monthly', nextDueDate: new Date().toISOString().split('T')[0], status: 'Partial' });
            const selectedSale = sales.find(s => s.invoiceNumber === formData.invoiceNumber);
            useEffect(() => { if (selectedSale) setFormData(p => ({...p, totalAmount: selectedSale.total, customerId: selectedSale.customerId || ''})); }, [selectedSale]);
            const remaining = (parseFloat(formData.totalAmount) || 0) - (parseFloat(formData.downPayment) || 0);
            const handleSubmit = (e) => { e.preventDefault(); onSave({...formData, totalAmount: parseFloat(formData.totalAmount)||0, downPayment: parseFloat(formData.downPayment)||0, installmentAmount: parseFloat(formData.installmentAmount)||0, remainingBalance: remaining}); };
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 rounded-xl border border-slate-700/50 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6 border-b border-slate-700/50"><h3 className="text-xl font-bold text-white">Create Installment Plan</h3></div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Invoice *</label>
                                    <select required value={formData.invoiceNumber} onChange={e => setFormData({...formData, invoiceNumber: e.target.value})} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50">
                                        <option value="">Select an invoice</option>
                                        {sales.map(s => <option key={s.id} value={s.invoiceNumber}>{s.invoiceNumber} – {formatCurrency(s.total)}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Customer *</label>
                                    <select required value={formData.customerId} onChange={e => setFormData({...formData, customerId: e.target.value})} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50">
                                        <option value="">Select a customer</option>
                                        {customers.map(c => <option key={c.id} value={c.id}>{c.fullName}</option>)}
                                    </select>
                                </div>
                                <div><label className="block text-sm font-medium text-slate-300 mb-2">Total Amount *</label><input type="number" required step="0.01" placeholder="Enter amount" value={formData.totalAmount} onChange={e => setFormData({...formData, totalAmount: e.target.value})} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-amber-500/50" /></div>
                                <div><label className="block text-sm font-medium text-slate-300 mb-2">Down Payment *</label><input type="number" required step="0.01" placeholder="Enter amount" value={formData.downPayment} onChange={e => setFormData({...formData, downPayment: e.target.value})} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-amber-500/50" /></div>
                                <div><label className="block text-sm font-medium text-slate-300 mb-2">Installment Amount *</label><input type="number" required step="0.01" placeholder="Enter amount" value={formData.installmentAmount} onChange={e => setFormData({...formData, installmentAmount: e.target.value})} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-amber-500/50" /></div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Frequency *</label>
                                    <select required value={formData.frequency} onChange={e => setFormData({...formData, frequency: e.target.value})} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50">
                                        <option value="Weekly">Weekly</option>
                                        <option value="Bi-weekly">Bi-weekly</option>
                                        <option value="Monthly">Monthly</option>
                                    </select>
                                </div>
                                <div className="sm:col-span-2"><label className="block text-sm font-medium text-slate-300 mb-2">First Due Date *</label><input type="date" required value={formData.nextDueDate} onChange={e => setFormData({...formData, nextDueDate: e.target.value})} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50" /></div>
                            </div>
                            {(parseFloat(formData.totalAmount) > 0) && (
                                <div className="bg-slate-900/50 rounded-lg p-4 space-y-2">
                                    <div className="flex justify-between text-sm"><span className="text-slate-400">Total:</span><span className="text-white font-medium">{formatCurrency(formData.totalAmount)}</span></div>
                                    <div className="flex justify-between text-sm"><span className="text-slate-400">Down Payment:</span><span className="text-emerald-400 font-medium">{formatCurrency(formData.downPayment)}</span></div>
                                    <div className="flex justify-between text-lg border-t border-slate-700/50 pt-2"><span className="text-white font-semibold">Remaining:</span><span className="text-amber-400 font-bold">{formatCurrency(remaining)}</span></div>
                                </div>
                            )}
                            <div className="flex gap-3 pt-4 border-t border-slate-700/50">
                                <button type="submit" className="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg">Create Plan</button>
                                <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function PaymentModal({ installment, onRecord, onClose }) {
            const [amount, setAmount] = useState(installment.installmentAmount);
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 rounded-xl border border-slate-700/50 max-w-md w-full">
                        <div className="p-6 border-b border-slate-700/50"><h3 className="text-xl font-bold text-white">Record Payment</h3><p className="text-sm text-slate-400 mt-1">Invoice: {installment.invoiceNumber}</p></div>
                        <form onSubmit={e => { e.preventDefault(); onRecord(installment.id, amount); }} className="p-6 space-y-4">
                            <div className="bg-slate-900/50 rounded-lg p-4 space-y-2">
                                <div className="flex justify-between text-sm"><span className="text-slate-400">Current Balance:</span><span className="text-amber-400 font-semibold">{formatCurrency(installment.remainingBalance)}</span></div>
                                <div className="flex justify-between text-sm"><span className="text-slate-400">Regular Installment:</span><span className="text-white">{formatCurrency(installment.installmentAmount)}</span></div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Payment Amount (max: {formatCurrency(installment.remainingBalance)})</label>
                                <input type="number" required step="0.01" min="0.01" max={installment.remainingBalance} value={amount} onChange={e => setAmount(parseFloat(e.target.value)||0)} className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50" />
                            </div>
                            <div className="bg-emerald-500/10 rounded-lg p-4 border border-emerald-500/30">
                                <div className="flex justify-between"><span className="text-emerald-400 font-semibold">New Balance:</span><span className="text-emerald-400 font-bold">{formatCurrency(Math.max(0, installment.remainingBalance - amount))}</span></div>
                            </div>
                            <div className="flex gap-3 pt-4 border-t border-slate-700/50">
                                <button type="submit" className="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg">Record Payment</button>
                                <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // ─── REPORTS TAB ─────────────────────────────────────────────────────────────
        function ReportsTab({ sales, products, installments }) {
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
            const [selectedYear, setSelectedYear]   = useState(new Date().getFullYear());

            const monthlySales     = sales.filter(s => { const d = new Date(s.date); return d.getMonth() === selectedMonth && d.getFullYear() === selectedYear; });
            const monthlyRevenue   = monthlySales.reduce((s,x) => s + x.total, 0);
            const monthlyProfit    = monthlySales.reduce((s,x) => s + x.profit, 0);
            const activeInstallments  = installments.filter(i => i.status !== 'Paid');
            const totalOutstanding    = activeInstallments.reduce((s,i) => s + i.remainingBalance, 0);
            const overdueInstallments = activeInstallments.filter(i => new Date(i.nextDueDate) < new Date());

            const productPerformance = products.map(p => {
                const ps = sales.filter(s => s.productId === p.id);
                return { ...p, totalSold: ps.reduce((a,s) => a + s.quantity, 0), totalRevenue: ps.reduce((a,s) => a + s.total, 0), totalProfit: ps.reduce((a,s) => a + s.profit, 0) };
            }).sort((a,b) => b.totalRevenue - a.totalRevenue);

            return (
                <div className="space-y-6">
                    <div><h2 className="text-2xl font-bold text-white">Business Reports</h2><p className="text-slate-400 text-sm">Comprehensive analytics and insights</p></div>
                    <div className="flex gap-4 items-center bg-slate-800/50 backdrop-blur rounded-xl p-4 border border-slate-700/50">
                        <Calendar className="w-5 h-5 text-amber-400" />
                        <select value={selectedMonth} onChange={e => setSelectedMonth(parseInt(e.target.value))} className="px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50">
                            {['January','February','March','April','May','June','July','August','September','October','November','December'].map((m,i) => <option key={m} value={i}>{m}</option>)}
                        </select>
                        <select value={selectedYear} onChange={e => setSelectedYear(parseInt(e.target.value))} className="px-3 py-2 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white focus:outline-none focus:border-amber-500/50">
                            {[2024,2025,2026].map(y => <option key={y} value={y}>{y}</option>)}
                        </select>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-gradient-to-br from-emerald-500/20 to-emerald-600/20 backdrop-blur rounded-xl p-6 border border-emerald-500/30"><div className="text-sm text-slate-300 font-medium mb-2">Monthly Revenue</div><div className="text-3xl font-bold text-white mb-1">{formatCurrency(monthlyRevenue)}</div><div className="text-xs text-emerald-400">{monthlySales.length} transactions</div></div>
                        <div className="bg-gradient-to-br from-blue-500/20 to-blue-600/20 backdrop-blur rounded-xl p-6 border border-blue-500/30"><div className="text-sm text-slate-300 font-medium mb-2">Monthly Profit</div><div className="text-3xl font-bold text-white mb-1">{formatCurrency(monthlyProfit)}</div><div className="text-xs text-blue-400">{((monthlyProfit/monthlyRevenue)*100||0).toFixed(1)}% margin</div></div>
                        <div className="bg-gradient-to-br from-amber-500/20 to-amber-600/20 backdrop-blur rounded-xl p-6 border border-amber-500/30"><div className="text-sm text-slate-300 font-medium mb-2">Outstanding Payments</div><div className="text-3xl font-bold text-white mb-1">{formatCurrency(totalOutstanding)}</div><div className="text-xs text-amber-400">{activeInstallments.length} active plans</div></div>
                    </div>
                    <div className="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700/50">
                        <h3 className="text-lg font-semibold text-white mb-4">Product Performance (All Time)</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-slate-900/50"><tr>{['Product','Units Sold','Revenue','Profit','Stock'].map(h => <th key={h} className="px-4 py-3 text-left text-xs font-semibold text-slate-300 uppercase">{h}</th>)}</tr></thead>
                                <tbody className="divide-y divide-slate-700/50">
                                    {productPerformance.slice(0,10).map(p => (
                                        <tr key={p.id} className="hover:bg-slate-900/30 transition-colors">
                                            <td className="px-4 py-3"><div className="font-medium text-white">{p.name}</div><div className="text-xs text-slate-400">{p.category}</div></td>
                                            <td className="px-4 py-3 text-white font-semibold">{p.totalSold}</td>
                                            <td className="px-4 py-3 text-emerald-400 font-semibold">{formatCurrency(p.totalRevenue)}</td>
                                            <td className="px-4 py-3 text-blue-400 font-semibold">{formatCurrency(p.totalProfit)}</td>
                                            <td className="px-4 py-3"><span className={`font-semibold ${p.quantityInStock <= p.minimumStockAlert ? 'text-red-400' : 'text-white'}`}>{p.quantityInStock}</span></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {overdueInstallments.length > 0 && (
                        <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-6">
                            <h3 className="text-lg font-semibold text-red-400 mb-4 flex items-center gap-2"><AlertCircle className="w-5 h-5" /> Overdue Installments ({overdueInstallments.length})</h3>
                            <div className="space-y-2">{overdueInstallments.map(i => <div key={i.id} className="flex justify-between items-center text-sm"><span className="text-slate-300">{i.invoiceNumber}</span><span className="text-red-400 font-semibold">{formatCurrency(i.remainingBalance)}</span></div>)}</div>
                        </div>
                    )}
                    <div className="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700/50">
                        <h3 className="text-lg font-semibold text-white mb-4">Inventory Summary</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><div className="text-sm text-slate-400 mb-1">Total Products</div><div className="text-2xl font-bold text-white">{products.length}</div></div>
                            <div><div className="text-sm text-slate-400 mb-1">Total Units in Stock</div><div className="text-2xl font-bold text-white">{products.reduce((s,p) => s + p.quantityInStock, 0)}</div></div>
                            <div><div className="text-sm text-slate-400 mb-1">Inventory Value</div><div className="text-2xl font-bold text-white">{formatCurrency(products.reduce((s,p) => s + p.purchaseCost * p.quantityInStock, 0))}</div></div>
                        </div>
                    </div>
                </div>
            );
        }

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InventoryManagementSystem />);
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
